{% extends "base.html" %}
{% block title %}STORM X - Mass Check{% endblock %}

{% block content %}
<div class="glass-card p-4">
    <div class="text-center mb-3">
        <h3 class="fw-bold"><i class="bi bi-collection me-2"></i>Mass Card Check</h3>
        <p class="text-muted mb-0">Check multiple cards in bulk with selected gateway</p>
    </div>

    <!-- Form -->
    <form id="massCardForm" class="mb-4">
        <div class="mb-3">
            <label for="card_list" class="form-label fw-semibold">Card List</label>
            <textarea
                class="form-control"
                id="card_list"
                name="card_list"
                rows="5"
                placeholder="Enter one card per line: NUMBER|MM|YY|CVV"></textarea>
            <div class="form-text">Enter one card per line or upload a .txt file</div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Or Upload File</label>
            <input type="file" class="form-control" id="card_file" accept=".txt">
        </div>

        <div class="mb-3">
            <label for="gateway" class="form-label fw-semibold">Gateway</label>
            <select class="form-select" id="gateway" name="gateway">
                <option value="au">Stripe Auth 1 </option>
                <option value="chk">Stripe Auth 2</option>
                <option value="vbv">3DS Lookup</option>
                <option value="b3">Braintree Auth</option>
                <option value="svb">3DS Site based</option>
                <option value="pp">Paypal [2$]</option>
            </select>
        </div>

        <div class="d-grid mb-4">
            <button type="submit" class="btn btn-warning btn-lg" id="massCheckButton">
                <i class="bi bi-arrow-repeat"></i> Start Mass Check
            </button>
        </div>
    </form>

    <!-- Stats Row -->
    <div class="row text-center g-2 mb-4">
        <div class="col-4">
            <div class="stat-card bg-success text-white p-3 rounded shadow-sm">
                <h6 class="mb-1">Approved</h6>
                <h3 id="approvedCount">0</h3>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-card bg-danger text-white p-3 rounded shadow-sm">
                <h6 class="mb-1">Declined</h6>
                <h3 id="declinedCount">0</h3>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-card bg-warning text-dark p-3 rounded shadow-sm">
                <h6 class="mb-1">Error</h6>
                <h3 id="errorCount">0</h3>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div id="massResults" class="results-list"></div>
</div>

<style>
.stat-card {
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border-radius: 12px;
}
.stat-card h6 { font-weight: 600; font-size: 0.9rem; }
.stat-card h3 { font-weight: 700; margin: 0; }
.result-box {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 12px;
    background: #f8f9fa;
    border-left: 6px solid #dee2e6;
}
.result-approved { background: #e8f8f0; border-left-color: #28a745; }
.result-declined { background: #fdeaea; border-left-color: #dc3545; }
.result-error { background: #fff8e6; border-left-color: #ffc107; }
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const massForm = document.getElementById('massCardForm');
    const resultsDiv = document.getElementById('massResults');
    const fileInput = document.getElementById('card_file');
    const textArea = document.getElementById('card_list');
    let currentCardList = '';

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(event) {
                textArea.value = event.target.result;
                currentCardList = event.target.result;
            };
            reader.readAsText(this.files[0]);
        }
    });

    // Update currentCardList when textarea changes
    textArea.addEventListener('input', function() {
        currentCardList = this.value;
    });

    // Initialize currentCardList with textarea value
    currentCardList = textArea.value;

    massForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const gateway = document.getElementById('gateway').value;
        
        // Use the currentCardList variable which is always updated
        const cardList = currentCardList.trim();

        if (!cardList) {
            alert('Please enter card list or upload a file');
            return;
        }

        startMassCheck(gateway, cardList);
    });

    function startMassCheck(gateway, cardList) {
    resultsDiv.innerHTML = '';
    let approved = 0, declined = 0, errors = 0;

    const btn = document.getElementById('massCheckButton');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';

    // Clear previous results
    document.getElementById('approvedCount').textContent = '0';
    document.getElementById('declinedCount').textContent = '0';
    document.getElementById('errorCount').textContent = '0';

    // Encode the card list properly
    const encodedCardList = encodeURIComponent(cardList);
    const url = `/mass_check?gateway=${encodeURIComponent(gateway)}&card_list=${encodedCardList}`;
    
    const eventSource = new EventSource(url);
    let isComplete = false;

    eventSource.onmessage = function(e) {
        try {
            const res = JSON.parse(e.data);
            
            // Check if this is a completion message
            if (res.complete) {
                eventSource.close();
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';
                
                // Show completion message
                const completeBox = document.createElement('div');
                completeBox.className = "result-box bg-info text-white";
                completeBox.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold"><i class="bi bi-check-circle"></i> Complete</h5>
                        <span class="badge bg-light text-dark">Done</span>
                    </div>
                    <p class="mb-0">Processed ${res.processed} of ${res.total} cards</p>
                `;
                resultsDiv.prepend(completeBox);
                return;
            }

            // Check if we have valid data
            if (res.card && res.status && res.response && res.gateway) {
                if (res.status === "Approved") approved++;
                else if (res.status === "Declined") declined++;
                else errors++;

                const box = document.createElement('div');
                box.className = "result-box " + 
                    (res.status === "Approved" ? "result-approved" :
                     res.status === "Declined" ? "result-declined" : "result-error");

                box.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold"><i class="bi bi-shield-lock"></i> Result</h5>
                        <span class="badge ${res.status === 'Approved' ? 'bg-success' : res.status === 'Declined' ? 'bg-danger' : 'bg-warning text-dark'}">${res.status}</span>
                    </div>
                    <p class="mb-1"><i class="bi bi-credit-card-2-front"></i> <strong>Card:</strong> ${res.card}</p>
                    <p class="mb-1"><i class="bi bi-chat-dots"></i> <strong>Response:</strong> ${res.response}</p>
                    <p class="mb-0"><i class="bi bi-hdd-network"></i> <strong>Gateway:</strong> ${res.gateway}</p>
                `;
                resultsDiv.prepend(box);

                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('declinedCount').textContent = declined;
                document.getElementById('errorCount').textContent = errors;
            } else if (res.error) {
                // Handle error response
                errors++;
                const box = document.createElement('div');
                box.className = "result-box result-error";
                box.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Error</h5>
                        <span class="badge bg-danger">Error</span>
                    </div>
                    <p class="mb-0">${res.error}</p>
                `;
                resultsDiv.prepend(box);
                document.getElementById('errorCount').textContent = errors;
            }
        } catch (error) {
            console.error('Error parsing message:', error);
            errors++;
            const box = document.createElement('div');
            box.className = "result-box result-error";
            box.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Error</h5>
                    <span class="badge bg-danger">Error</span>
                </div>
                <p class="mb-0">Failed to parse response: ${error.message}</p>
            `;
            resultsDiv.prepend(box);
            document.getElementById('errorCount').textContent = errors;
        }
    };

    eventSource.onerror = function(e) {
        console.error('EventSource error:', e);
        if (!isComplete) {
            eventSource.close();
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';
            
            // Show error message if no results were received
            if (approved === 0 && declined === 0 && errors === 0) {
                errors++;
                const errorBox = document.createElement('div');
                errorBox.className = "result-box result-error";
                errorBox.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Error</h5>
                        <span class="badge bg-danger">Failed</span>
                    </div>
                    <p class="mb-0">Connection error. Please check your connection and try again.</p>
                `;
                resultsDiv.prepend(errorBox);
                document.getElementById('errorCount').textContent = errors;
            }
        }
    };

    // Add timeout to close connection if it hangs
    setTimeout(() => {
        if (eventSource.readyState !== EventSource.CLOSED && !isComplete) {
            eventSource.close();
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';
            
            // Show timeout message
            const timeoutBox = document.createElement('div');
            timeoutBox.className = "result-box result-error";
            timeoutBox.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold"><i class="bi bi-clock-history"></i> Timeout</h5>
                    <span class="badge bg-warning text-dark">Timeout</span>
                </div>
                <p class="mb-0">Mass check timed out after 30 seconds</p>
            `;
            resultsDiv.prepend(timeoutBox);
        }
    }, 30000); // 30 second timeout
}

        // Add timeout to close connection if it hangs
        setTimeout(() => {
            if (eventSource.readyState !== EventSource.CLOSED) {
                eventSource.close();
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';
            }
        }, 30000); // 30 second timeout
    }
);

</script>
{% endblock %}
