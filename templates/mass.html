<script>
document.addEventListener('DOMContentLoaded', function() {
    const massForm = document.getElementById('massCardForm');
    const resultsDiv = document.getElementById('massResults');
    const fileInput = document.getElementById('card_file');
    const textArea = document.getElementById('card_list');
    let currentCardList = '';

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(event) {
                textArea.value = event.target.result;
                currentCardList = event.target.result;
            };
            reader.readAsText(this.files[0]);
        }
    });

    // Update currentCardList when textarea changes
    textArea.addEventListener('input', function() {
        currentCardList = this.value;
    });

    // Initialize currentCardList with textarea value
    currentCardList = textArea.value;

    massForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const gateway = document.getElementById('gateway').value;
        const cardList = currentCardList.trim();

        if (!cardList) {
            alert('Please enter card list or upload a file');
            return;
        }

        startMassCheck(gateway, cardList);
    });

    function startMassCheck(gateway, cardList) {
        resultsDiv.innerHTML = '';
        let approved = 0, declined = 0, errors = 0;

        const btn = document.getElementById('massCheckButton');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';

        // Show gateway being used
        const gatewayInfo = document.createElement('div');
        gatewayInfo.className = "alert alert-info mb-3";
        gatewayInfo.innerHTML = `<i class="bi bi-info-circle"></i> Using gateway: ${gateway.toUpperCase()}`;
        resultsDiv.appendChild(gatewayInfo);

        // Encode the card list properly
        const encodedCardList = encodeURIComponent(cardList);
        const url = `/mass_check?gateway=${encodeURIComponent(gateway)}&card_list=${encodedCardList}`;
        
        const eventSource = new EventSource(url);
        let isComplete = false;

        eventSource.onmessage = function(e) {
            try {
                const res = JSON.parse(e.data);

                if (res.complete) {
                    isComplete = true;
                    eventSource.close();
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';

                    const completeBox = document.createElement('div');
                    completeBox.className = "result-box bg-success text-white";
                    completeBox.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="fw-bold"><i class="bi bi-check-circle"></i> Complete</h5>
                            <span class="badge bg-light text-dark">${res.successful}/${res.processed} Successful</span>
                        </div>
                        <p class="mb-0">Processed ${res.processed} of ${res.total} cards</p>
                    `;
                    resultsDiv.prepend(completeBox);
                    return;
                }

                if (res.card && res.status && res.response && res.gateway) {
                    if (res.status === "Approved") approved++;
                    else if (res.status === "Declined") declined++;
                    else errors++;

                    const box = document.createElement('div');
                    box.className = "result-box " + 
                        (res.status === "Approved" ? "result-approved" :
                         res.status === "Declined" ? "result-declined" : "result-error");

                    box.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="fw-bold"><i class="bi bi-shield-lock"></i> Result</h5>
                            <span class="badge ${res.status === 'Approved' ? 'bg-success' : res.status === 'Declined' ? 'bg-danger' : 'bg-warning text-dark'}">${res.status}</span>
                        </div>
                        <p class="mb-1"><i class="bi bi-credit-card-2-front"></i> <strong>Card:</strong> ${res.card}</p>
                        <p class="mb-1"><i class="bi bi-chat-dots"></i> <strong>Response:</strong> ${res.response}</p>
                        <p class="mb-0"><i class="bi bi-hdd-network"></i> <strong>Gateway:</strong> ${res.gateway}</p>
                    `;
                    resultsDiv.prepend(box);

                    document.getElementById('approvedCount').textContent = approved;
                    document.getElementById('declinedCount').textContent = declined;
                    document.getElementById('errorCount').textContent = errors;
                }
            } catch (error) {
                console.error('Error parsing message:', error);
            }
        };

        eventSource.onerror = function(e) {
            if (!isComplete) {
                eventSource.close();
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';

                const errorBox = document.createElement('div');
                errorBox.className = "result-box result-error";
                errorBox.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Connection Error</h5>
                        <span class="badge bg-danger">Failed</span>
                    </div>
                    <p class="mb-0">The connection was interrupted. This often happens when gateways are slow or blocking requests.</p>
                    <p class="mb-0 mt-2"><strong>Tip:</strong> Try using the VBV/3DS gateway which is more reliable.</p>
                `;
                resultsDiv.prepend(errorBox);
            }
        };

        setTimeout(() => {
            if (!isComplete) {
                eventSource.close();
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';

                const timeoutBox = document.createElement('div');
                timeoutBox.className = "result-box result-error";
                timeoutBox.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-bold"><i class="bi bi-clock-history"></i> Timeout</h5>
                        <span class="badge bg-warning text-dark">Timeout</span>
                    </div>
                    <p class="mb-0">Mass check timed out. The gateway may be slow or blocking requests.</p>
                    <p class="mb-0 mt-2"><strong>Tip:</strong> Try using the VBV/3DS gateway for better reliability.</p>
                `;
                resultsDiv.prepend(timeoutBox);
            }
        }, 120000);
    } // closes startMassCheck
}); // closes DOMContentLoaded
</script>
