<script>
document.addEventListener('DOMContentLoaded', function () {
    const massForm = document.getElementById('massCardForm');
    const resultsDiv = document.getElementById('massResults');
    const fileInput = document.getElementById('card_file');
    const textArea = document.getElementById('card_list');
    const btn = document.getElementById('massCheckButton');

    // Verify required elements exist
    if (!massForm || !resultsDiv || !fileInput || !textArea || !btn) {
        console.error("❌ Missing required HTML elements. Check your IDs in HTML.");
        return;
    }

    let currentCardList = textArea.value;

    // Handle file upload
    fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function (event) {
                textArea.value = event.target.result;
                currentCardList = event.target.result;
            };
            reader.readAsText(this.files[0]);
        }
    });

    // Track textarea input
    textArea.addEventListener('input', () => currentCardList = textArea.value);

    // Handle form submit
    massForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const gateway = document.getElementById('gateway')?.value || "";
        const cardList = currentCardList.trim();

        if (!cardList) {
            alert('Please enter card list or upload a file');
            return;
        }

        startMassCheck(gateway, cardList);
    });

    // Helper to prepend elements (safe for all browsers)
    function safePrepend(parent, el) {
        parent.insertBefore(el, parent.firstChild);
    }

    async function startMassCheck(gateway, cardList) {
        resultsDiv.innerHTML = '';
        let approved = 0, declined = 0, errors = 0;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';

        const gatewayInfo = document.createElement('div');
        gatewayInfo.className = "alert alert-info mb-3";
        gatewayInfo.innerHTML = `<i class="bi bi-info-circle"></i> Using gateway: ${gateway.toUpperCase()}`;
        safePrepend(resultsDiv, gatewayInfo);

        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 120000); // 2 min timeout

            const response = await fetch("/mass_check", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ gateway, card_list: cardList }),
                signal: controller.signal
            });

            clearTimeout(timeout);

            if (!response.ok) throw new Error(`Server returned ${response.status}`);
            
            // Expect server to return NDJSON (one JSON per line)
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });

                let lines = buffer.split("\n");
                buffer = lines.pop(); // Keep last incomplete line

                for (let line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const res = JSON.parse(line);
                        if (res.complete) {
                            showCompleteBox(res);
                            continue;
                        }
                        if (res.card && res.status) {
                            if (res.status === "Approved") approved++;
                            else if (res.status === "Declined") declined++;
                            else errors++;
                            showResultBox(res);
                        }
                        updateCounts();
                    } catch (err) {
                        console.error("JSON parse error:", err);
                    }
                }
            }

            if (buffer.trim()) {
                try {
                    const res = JSON.parse(buffer);
                    if (res.complete) showCompleteBox(res);
                    else showResultBox(res);
                } catch (err) {
                    console.error("JSON parse error at end:", err);
                }
            }

        } catch (err) {
            console.error("Mass check failed:", err);
            const errorBox = document.createElement('div');
            errorBox.className = "result-box result-error";
            errorBox.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> Error</h5>
                    <span class="badge bg-danger">Failed</span>
                </div>
                <p class="mb-0">Unable to connect or process. Please try again later.</p>
            `;
            safePrepend(resultsDiv, errorBox);
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Start Mass Check';

        function updateCounts() {
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('declinedCount').textContent = declined;
            document.getElementById('errorCount').textContent = errors;
        }

        function showResultBox(res) {
            const box = document.createElement('div');
            box.className = "result-box " +
                (res.status === "Approved" ? "result-approved" :
                 res.status === "Declined" ? "result-declined" : "result-error");

            box.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold"><i class="bi bi-shield-lock"></i> Result</h5>
                    <span class="badge ${res.status === 'Approved' ? 'bg-success' : res.status === 'Declined' ? 'bg-danger' : 'bg-warning text-dark'}">${res.status}</span>
                </div>
                <p class="mb-1"><i class="bi bi-credit-card-2-front"></i> <strong>Card:</strong> ${res.card}</p>
                <p class="mb-1"><i class="bi bi-chat-dots"></i> <strong>Response:</strong> ${res.response}</p>
                <p class="mb-0"><i class="bi bi-hdd-network"></i> <strong>Gateway:</strong> ${res.gateway}</p>
            `;
            safePrepend(resultsDiv, box);
        }

        function showCompleteBox(res) {
            const completeBox = document.createElement('div');
            completeBox.className = "result-box bg-success text-white";
            completeBox.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold"><i class="bi bi-check-circle"></i> Complete</h5>
                    <span class="badge bg-light text-dark">${res.successful}/${res.processed} Successful</span>
                </div>
                <p class="mb-0">Processed ${res.processed} of ${res.total} cards</p>
            `;
            safePrepend(resultsDiv, completeBox);
        }
    }
});
</script>
