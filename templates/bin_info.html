{% extends "base.html" %}
{% block title %}BIN Info - STORM X{% endblock %}
{% block content %}
<div class="container py-3">
  <div class="glass-card p-3">
    <h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>BIN Information Lookup</h4>
    
    <form id="binInfoForm">
      <div class="mb-3">
        <label class="form-label small text-muted">Enter BIN (first 6 digits)</label>
        <input type="text" class="form-control form-control-sm" id="binNumber" name="bin" required 
               pattern="[0-9]{6}" placeholder="e.g., 543453" maxlength="6">
      </div>
      <button type="submit" class="btn btn-primary btn-sm">
        <i class="bi bi-search me-1"></i> Lookup BIN
      </button>
    </form>
    
    <div id="errorMessage" class="alert alert-danger mt-3 py-2 small mb-0 d-none"></div>
    
    <div id="binResults" class="mt-3 d-none">
      <hr>
      <h5 class="mb-2">BIN Details:</h5>
      
      <div class="row small">
        <div class="col-md-6">
          <div class="d-flex justify-content-between border-bottom py-1">
            <span class="text-muted">BIN:</span>
            <span class="fw-medium" id="binValue"></span>
          </div>
          <div class="d-flex justify-content-between border-bottom py-1">
            <span class="text-muted">Brand:</span>
            <span class="fw-medium" id="binBrand"></span>
          </div>
          <div class="d-flex justify-content-between border-bottom py-1">
            <span class="text-muted">Type:</span>
            <span class="fw-medium" id="binType"></span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-between border-bottom py-1">
            <span class="text-muted">Level:</span>
            <span class="fw-medium" id="binLevel"></span>
          </div>
          <div class="d-flex justify-content-between border-bottom py-1">
            <span class="text-muted">Bank:</span>
            <span class="fw-medium" id="binBank"></span>
          </div>
          <div class="d-flex justify-content-between border-bottom py-1">
            <span class="text-muted">Country:</span>
            <span class="fw-medium" id="binCountry"></span>
          </div>
        </div>
      </div>
      
      <div id="binCurrencies" class="mt-2 small d-none">
        <span class="text-muted">Currencies:</span>
        <span id="currencyList"></span>
      </div>
    </div>
  </div>
</div>

<style>
.glass-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border: 1px solid rgba(255,255,255,0.2);
}

body.dark-mode .glass-card {
  background: rgba(20, 20, 20, 0.9);
  border: 1px solid rgba(255,255,255,0.1);
}

.small {
  font-size: 0.85rem;
}

.border-bottom {
  border-color: rgba(0,0,0,0.1) !important;
}

body.dark-mode .border-bottom {
  border-color: rgba(255,255,255,0.1) !important;
}

.form-control-sm {
  font-size: 0.85rem;
  padding: 0.25rem 0.5rem;
}

.btn-sm {
  padding: 0.25rem 0.75rem;
  font-size: 0.85rem;
}
</style>

<script>
document.getElementById('binInfoForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const binNumber = document.getElementById('binNumber').value.trim();
  const errorDiv = document.getElementById('errorMessage');
  const resultsDiv = document.getElementById('binResults');
  const btn = e.target.querySelector('button[type="submit"]');
  
  if (!binNumber || binNumber.length !== 6) {
    errorDiv.textContent = 'Please enter a valid 6-digit BIN';
    errorDiv.classList.remove('d-none');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
  errorDiv.classList.add('d-none');
  resultsDiv.classList.add('d-none');
  
  try {
    const response = await fetch('/bin_info', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'bin': binNumber
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      const binData = data.data;
      
      // Update the results
      document.getElementById('binValue').textContent = binData.bin || 'N/A';
      document.getElementById('binBrand').textContent = binData.brand || 'N/A';
      document.getElementById('binType').textContent = binData.type || 'N/A';
      document.getElementById('binLevel').textContent = binData.level || 'N/A';
      document.getElementById('binBank').textContent = binData.bank || 'N/A';
      
      // Format country info
      let countryText = '';
      if (binData.country_flag) countryText += binData.country_flag + ' ';
      countryText += binData.country_name || binData.country || 'N/A';
      document.getElementById('binCountry').textContent = countryText;
      
      // Handle currencies
      const currencyDiv = document.getElementById('binCurrencies');
      const currencyList = document.getElementById('currencyList');
      if (binData.country_currencies && binData.country_currencies.length > 0) {
        currencyList.innerHTML = '';
        binData.country_currencies.forEach(currency => {
          currencyList.innerHTML += `<span class="badge bg-secondary ms-1">${currency}</span>`;
        });
        currencyDiv.classList.remove('d-none');
      } else {
        currencyDiv.classList.add('d-none');
      }
      
      resultsDiv.classList.remove('d-none');
    } else {
      errorDiv.textContent = data.error || 'Error fetching BIN information';
      errorDiv.classList.remove('d-none');
    }
  } catch (error) {
    errorDiv.textContent = 'Network error: ' + error.message;
    errorDiv.classList.remove('d-none');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-search me-1"></i> Lookup BIN';
  }
});
</script>
{% endblock %}
